{% extends "base.html" %}

{% block title %}Check Out{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-camera me-2"></i>Check Out Process</h5>
            </div>
            <div class="card-body p-4">
                <!-- Location preference -->
                {% if location_allowed %}
                <div id="locationPreference" class="mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="captureLocation" checked>
                        <label class="form-check-label" for="captureLocation">
                            <i class="fas fa-map-marker-alt me-1"></i>Capture my location
                        </label>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    Location tracking is disabled for your account by administrator.
                </div>
                {% endif %}

                <div id="step1" class="step-container">
                    <div class="text-center mb-4">
                        <h4>Step 1: Front Camera</h4>
                        <p class="text-muted">Please position yourself in front of the camera</p>
                    </div>
                    
                    <div class="text-center mb-3">
                        <video id="frontVideo" width="100%" height="auto" autoplay style="max-width: 500px; border-radius: 10px; border: 3px solid #dc3545;"></video>
                        <canvas id="frontCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="text-center">
                        <button id="captureFrontBtn" class="btn btn-danger btn-lg">
                            <i class="fas fa-camera me-2"></i>Capture Front Photo
                        </button>
                    </div>
                </div>

                <div id="step2" class="step-container" style="display: none;">
                    <div class="text-center mb-4">
                        <h4>Step 2: Rear Camera</h4>
                        <p class="text-muted">Switch to rear camera to capture your surroundings</p>
                    </div>
                    
                    <div class="text-center mb-3">
                        <video id="rearVideo" width="100%" height="auto" autoplay style="max-width: 500px; border-radius: 10px; border: 3px solid #6c757d;"></video>
                        <canvas id="rearCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="text-center">
                        <button id="captureRearBtn" class="btn btn-secondary btn-lg">
                            <i class="fas fa-camera me-2"></i>Capture Rear Photo
                        </button>
                    </div>
                </div>

                <div id="step3" class="step-container" style="display: none;">
                    <div class="text-center mb-4">
                        <h4>Step 3: Getting Location...</h4>
                        <p class="text-muted">Please wait while we capture your location</p>
                        <div class="spinner-border text-danger mt-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <div id="step4" class="step-container" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-check-circle fa-4x text-danger mb-3"></i>
                        <h4>Check-Out Successful!</h4>
                        <p class="text-muted">Have a great day!</p>
                        <a href="{{ url_for('user_dashboard') }}" class="btn btn-danger mt-3">
                            <i class="fas fa-home me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>

                <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let frontStream, rearStream;
let checkoutFrontImageData, checkoutRearImageData;
let locationData = {};
let captureLocationEnabled = {{ 'true' if location_allowed else 'false' }};

// Check location preference - only if admin allows
{% if location_allowed %}
document.getElementById('captureLocation')?.addEventListener('change', function() {
    captureLocationEnabled = this.checked;
});
{% endif %}

// Step 1: Front Camera
async function startFrontCamera() {
    try {
        frontStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'user' } 
        });
        document.getElementById('frontVideo').srcObject = frontStream;
    } catch (error) {
        showError('Camera access denied. Please allow camera permissions.');
    }
}

document.getElementById('captureFrontBtn').addEventListener('click', function() {
    const video = document.getElementById('frontVideo');
    const canvas = document.getElementById('frontCanvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    checkoutFrontImageData = canvas.toDataURL('image/jpeg');
    
    // Stop front camera
    frontStream.getTracks().forEach(track => track.stop());
    
    // Move to step 2
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    startRearCamera();
});

// Step 2: Rear Camera
async function startRearCamera() {
    try {
        rearStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } 
        });
        document.getElementById('rearVideo').srcObject = rearStream;
    } catch (error) {
        try {
            rearStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' } 
            });
            document.getElementById('rearVideo').srcObject = rearStream;
        } catch (err) {
            showError('Camera access failed. Please check permissions.');
        }
    }
}

document.getElementById('captureRearBtn').addEventListener('click', function() {
    const video = document.getElementById('rearVideo');
    const canvas = document.getElementById('rearCanvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    checkoutRearImageData = canvas.toDataURL('image/jpeg');
    
    // Stop rear camera
    rearStream.getTracks().forEach(track => track.stop());
    
    // Move to step 3
    document.getElementById('step2').style.display = 'none';
    
    if (captureLocationEnabled) {
        document.getElementById('step3').style.display = 'block';
        getLocation();
    } else {
        // Skip location capture
        locationData.latitude = null;
        locationData.longitude = null;
        locationData.city = 'Location not captured';
        locationData.full_address = 'Location not captured';
        submitCheckout();
    }
});

// Step 3: Get Location
function getLocation() {
    if (!navigator.geolocation) {
        locationData.latitude = null;
        locationData.longitude = null;
        locationData.city = 'Geolocation not supported';
        submitCheckout();
        return;
    }
    
    const options = {
        enableHighAccuracy: true, // TRUE for actual GPS
        timeout: 15000, // 15 seconds
        maximumAge: 0 // Don't use cached
    };
    
    navigator.geolocation.getCurrentPosition(
        async function(position) {
            locationData.latitude = position.coords.latitude;
            locationData.longitude = position.coords.longitude;
            
            console.log('✓ Checkout location:', locationData.latitude, locationData.longitude);
            
            await getCityName();
            submitCheckout();
        },
        function(error) {
            console.error('Geolocation error:', error);
            locationData.latitude = null;
            locationData.longitude = null;
            locationData.city = 'Location unavailable';
            locationData.full_address = 'Could not capture location';
            submitCheckout();
        },
        options
    );
}

async function getCityName() {
    try {
        // Try OpenStreetMap first - more accurate for Indian locations
        const osmResponse = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${locationData.latitude}&lon=${locationData.longitude}&format=json&addressdetails=1`,
            {
                headers: {
                    'User-Agent': 'AttendanceSystem/1.0'
                }
            }
        );
        
        if (osmResponse.ok) {
            const osmData = await osmResponse.json();
            console.log('OSM Full Data:', osmData);
            
            // Get most specific location - prioritize neighborhood/suburb over city
            const addr = osmData.address;
            locationData.city = addr.neighbourhood 
                || addr.suburb 
                || addr.quarter
                || addr.hamlet
                || addr.village
                || addr.town
                || addr.city 
                || addr.state_district
                || addr.state
                || 'Location captured';
            
            // Build full address with all available details
            const addressParts = [
                addr.road,
                addr.neighbourhood || addr.suburb,
                addr.village || addr.town || addr.city,
                addr.state_district,
                addr.state,
                addr.country
            ].filter(Boolean);
            
            locationData.full_address = addressParts.join(', ');
            
            console.log('✓ Checkout location:', locationData.city);
            console.log('Full address:', locationData.full_address);
            return;
        }
    } catch (error) {
        console.log('OpenStreetMap failed, trying BigDataCloud...', error);
    }
    
    // Fallback to BigDataCloud
    try {
        const bdcResponse = await fetch(
            `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${locationData.latitude}&longitude=${locationData.longitude}&localityLanguage=en`
        );
        
        if (bdcResponse.ok) {
            const bdcData = await bdcResponse.json();
            console.log('BDC Full Data:', bdcData);
            
            locationData.city = bdcData.locality 
                || bdcData.localityInfo?.administrative?.[3]?.name
                || bdcData.city 
                || bdcData.principalSubdivision 
                || 'Location captured';
            
            const addressComponents = bdcData.localityInfo?.administrative || [];
            locationData.full_address = addressComponents.map(a => a.name).join(', ') || locationData.city;
            
            console.log('✓ Checkout location:', locationData.city);
            console.log('Full address:', locationData.full_address);
            return;
        }
    } catch (error) {
        console.log('BigDataCloud failed:', error);
    }
    
    locationData.city = 'Location captured (coordinates only)';
    locationData.full_address = `Lat: ${locationData.latitude}, Lon: ${locationData.longitude}`;
}

// Step 4: Submit Checkout
async function submitCheckout() {
    try {
        const response = await fetch('/api/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                checkout_front_image: checkoutFrontImageData,
                checkout_rear_image: checkoutRearImageData,
                checkout_latitude: locationData.latitude,
                checkout_longitude: locationData.longitude,
                checkout_city: locationData.city,
                checkout_full_address: locationData.full_address || locationData.city
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step4').style.display = 'block';
        } else {
            showError('Check-out failed. Please try again.');
        }
    } catch (error) {
        showError('Network error. Please check your connection.');
    }
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

// Start the process
startFrontCamera();
</script>
{% endblock %}